<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">    
   
<head>
  <title>会員情報編集</title>
  <th:block th:replace="~{fragment :: meta}"/>
  <th:block th:replace="~{fragment :: styles}"/>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
   
   
   <body>
       <div class="samuraitravel-wrapper">
           <!-- ヘッダー -->
           <div th:replace="~{fragment :: header}"></div>
           
           <main>
               <div class="container pb-5 samuraitravel-container">
                   <div class="row justify-content-center">
                       <div class="col-xl-5 col-lg-6 col-md-8">
                           <nav class="my-3" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                               <ol class="breadcrumb mb-0"> 
                                   <li class="breadcrumb-item"><a th:href="@{/}">ホーム</a></li>                       
                                   <li class="breadcrumb-item"><a th:href="@{/user}">会員情報</a></li>
                                   <li class="breadcrumb-item active" aria-current="page">会員情報編集</li>
                               </ol>
                           </nav> 
                           
                           <h1 class="mb-4 text-center">会員情報編集</h1>         
                           
                           <form method="post" th:action="@{/user/update}" th:object="${userEditForm}">
                               <input type="hidden" th:field="*{id}">
                               
                               <div class="form-group row mb-3">
                                   <div class="col-md-5">
                                       <label for="name" class="col-form-label text-md-left fw-bold">
                                           <div class="d-flex align-items-center">
                                               <span class="me-1">氏名</span>
                                               <span class="badge bg-danger">必須</span>
                                           </div>
                                       </label>
                                   </div>
                                   <div class="col-md-7">                                    
                                       <div th:if="${#fields.hasErrors('name')}" class="text-danger small mb-2" th:errors="*{name}"></div>                                    
                                       <input type="text" class="form-control" th:field="*{name}" autocomplete="name" autofocus placeholder="侍 太郎">
                                   </div>
                               </div>
                               
                               <div class="form-group row mb-3">
                                   <div class="col-md-5">
                                       <label for="furigana" class="col-form-label text-md-left fw-bold">
                                           <div class="d-flex align-items-center">
                                               <span class="me-1">フリガナ</span>
                                               <span class="badge bg-danger">必須</span>
                                           </div>
                                       </label>
                                   </div>
                                   <div class="col-md-7">                            
                                       <div th:if="${#fields.hasErrors('furigana')}" class="text-danger small mb-2" th:errors="*{furigana}"></div>                                        
                                       <input type="text" class="form-control" th:field="*{furigana}" placeholder="サムライ タロウ">
                                   </div>
                               </div>
                                                                                                                       
                               <div class="form-group row mb-3">
                                   <div class="col-md-5">
                                       <label for="postalCode" class="col-form-label text-md-left fw-bold">
                                            <div class="d-flex align-items-center">
                                                <span class="me-1">郵便番号</span>
                                                <span class="badge bg-danger">必須</span>
                                            </div>
                                        </label>
                                   </div>
                                   <div class="col-md-7">
                                       <div th:if="${#fields.hasErrors('postalCode')}" class="text-danger small mb-2" th:errors="*{postalCode}"></div>
                                       <input type="text" class="form-control" th:field="*{postalCode}" autocomplete="postal-code" placeholder="101-0022">
                                   </div>
                               </div>
                                                                                                             
                               <div class="form-group row mb-3">
                                   <div class="col-md-5">
                                       <label for="address" class="col-form-label text-md-left fw-bold">
                                            <div class="d-flex align-items-center">
                                                <span class="me-1">住所</span>
                                                <span class="badge bg-danger">必須</span>
                                            </div>
                                        </label>
                                   </div>
                                   <div class="col-md-7">
                                        <div th:if="${#fields.hasErrors('address')}"  class="text-danger small mb-2" th:errors="*{address}"></div>
                                       <input type="text" class="form-control" th:field="*{address}" placeholder="東京都千代田区神田練塀町300番地">  
                                   </div>
                               </div>                                                                                
                               
                               <div class="form-group row mb-3">
                                   <div class="col-md-5">
                                       <label for="phoneNumber" class="col-form-label text-md-left fw-bold">
                                            <div class="d-flex align-items-center">
                                                <span class="me-1">電話番号</span>
                                                <span class="badge bg-danger">必須</span>
                                            </div>
                                       </label>
                                   </div>
                                   <div class="col-md-7">
                                        <div th:if="${#fields.hasErrors('phoneNumber')}" class="text-danger small mb-2" th:errors="*{phoneNumber}"></div>
                                       <input type="text" class="form-control" th:field="*{phoneNumber}" autocomplete="tel-national" placeholder="090-1234-5678">                                
                                   </div>
                               </div>
                                                                                                                       
                               <div class="form-group row mb-3">
                                   <div class="col-md-5">
                                       <label for="email" class="col-form-label text-md-left fw-bold">
                                           <div class="d-flex align-items-center">
                                               <span class="me-1">メールアドレス</span>
                                               <span class="badge bg-danger">必須</span>
                                           </div>
                                       </label>
                                   </div>
                                   <div class="col-md-7">
                                       <div th:if="${#fields.hasErrors('email')}" class="text-danger small mb-2" th:errors="*{email}"></div>
                                       <input type="text" class="form-control" th:field="*{email}" autocomplete="email" placeholder="taro.samurai@example.com">
                                   </div>
                               </div>
                               
                               <div class="form-group d-flex justify-content-center my-4">
                                   <button type="submit" class="btn text-white shadow-sm w-50 samuraitravel-btn">更新</button>
                               </div>
                               
                           </form>
                           
                           <!-- サブスク登録セクション -->

							<h2 class="text-center mb-4">サブスクリプション情報</h2>
							
							<div class="mt-4 text-center">
								<div th:if="${userEditForm.role.name == 'ROLE_PREMIUM'}">
									<span class="badge bg-success">サブスク会員</span>
								    <div class="text-center mt-3">
									<a th:href="@{/api/cancel}" class="btn btn-outline-danger">サブスクリプションを解除</a>  
									</div>
								</div>
							 	<div th:unless="${userEditForm.role.name == 'ROLE_PREMIUM'}">
								    <span class="badge bg-secondary">未登録</span>	    
									<div class="mt-5">
										<form id="subscription-form">
										    <div class="form-group d-flex justify-content-center mt-4">
												<button type="submit" class="btn btn-primary w-50">サブスク登録</button>
										    </div>
										</form>
									</div>
								</div>
							</div>                                                                
                       </div>
                   </div>
               </div>
           </main>
           
           <!-- フッター -->
           <div th:replace="~{fragment :: footer}"></div>
       </div>    
       
       <div th:replace="~{fragment :: scripts}"></div>  
       
       <script src="https://js.stripe.com/v3/"></script>
       
<script>
	
  const stripe = Stripe('pk_test_51R7pH2CkhpTGubr3lghM62v5rWM7k5t8W9Sz7qRiLlGJcqVk9J8A7HSPTi9QsH2WwiP01hXyGC1Mhjzl5Q8IgzEH00HQ0kyVhv'); // あなたの公開キーに置き換えてください

document.addEventListener('DOMContentLoaded', () => {
  const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

  const form = document.getElementById('subscription-form');
  if (form) {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      try {
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
          }
        });

        if (!response.ok) {
          throw new Error('Checkoutセッションの作成に失敗しました');
        }

        const checkoutUrl = await response.text();
        window.location.href = checkoutUrl;
      } catch (error) {
        console.error('エラー:', error);
        alert('サブスクリプション登録中にエラーが発生しました。もう一度お試しください。');
      }
    });
  }

  const updateCardBtn = document.getElementById('update-card-btn');
  if (updateCardBtn) {
    updateCardBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/create-portal-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
          }
        });

        if (!response.ok) {
          throw new Error('ポータルセッションの作成に失敗しました');
        }

        const data = await response.json();
        window.location.href = data.url;
      } catch (error) {
        alert('エラーが発生しました: ' + error.message);
      }
    });
  }
});



	


</script>       

 </body>
</html>



